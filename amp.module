<?php

/**
 * @file
 * Contains amp.module.
 */

/**
 * Implements hook_help().
 */
function amp_help($path, $arg) {
  switch ($path) {
    case 'admin/help#amp':
      $output = '';
      $output .= '<h3>' . t('About') . '</h3>';
      $output .= '<p>' . t('Google AMP integration') . '</p>';
      return $output;
  }
}

/**
 * Implements hook_menu().
 */
function amp_menu() {
  $items = array();
  $items['admin/config/content/amp'] = array(
    'title' => 'AMP Configuration',
    'description' => 'Configure the AMP module',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('amp_admin_form'),
    'access arguments' => array('administer site configuration'),
    'type' => MENU_NORMAL_ITEM,
    'file' => 'amp.admin.inc',
  );
  return $items;
}



/**
 * Implements hook_entity_info_alter().
 */
function amp_entity_info_alter(&$entity_info) {
  $entity_info['node']['view modes']['amp'] = array(
    'label' => t('AMP'),
    'custom settings' => FALSE,
  );
}

/**
 * Determines whether a request should return AMP HTML.
 */
function amp_is_amp_request() {

  // Get current path.
  $path = current_path();

  // Get current URL.
  $current_url = url(current_path(), array('absolute' => TRUE));

  // Check if URL ends with '/amp'
  if (stripos(strrev($current_url), strrev('/amp')) === 0) {
    // Get system path.
    $system_path = drupal_lookup_path('source', $path);

    // Load menu item based on system path.
    $menu_item = menu_get_item($system_path ? $system_path : current_path());

    if ($menu_item && isset($menu_item['page_arguments'][0])) {
      // Load the node.
      $node = $menu_item['page_arguments'][0];

      // Get node type.
      $node_type = node_type_get_type($node);

      // Get view mode settings for node type.
      if ($node_type) {
        $view_mode_settings = field_view_mode_settings('node', $node_type->type);
      }
      if (isset($view_mode_settings['amp']) && $view_mode_settings['amp']['custom_settings']) {
        return TRUE;
      }
    }
  }

  return FALSE;
}

/**
 * Implements hook_custom_theme().
 */
function amp_custom_theme() {
  if (amp_is_amp_request()) {
    return variable_get('amp_theme');
  }
}

/**
 * Implements hook_entity_view_mode_alter().
 *
 * Switches view mode to 'amp' for AMP requests.
 */
function amp_entity_view_mode_alter(&$view_mode, $context) {
  if ($view_mode === 'full' && amp_is_amp_request()) {
    $view_mode = 'amp';
  }
}
